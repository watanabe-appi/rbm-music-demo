<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Piano Roll Player</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
        }

        .player {
            margin: 20px 0;
            text-align: center;
        }

        .container {
            position: relative;
            display: inline-block;
            border: 1px solid #666;
            background: #000;
        }

        .pianoRoll {
            display: block;
            max-width: 100%;
            /* レスポンシブ対応 */
            height: auto;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: red;
            left: 0;
            pointer-events: none;
        }

        .controls {
            margin-top: 10px;
        }

        button {
            margin: 0 5px;
        }
    </style>
</head>

<body>
    <h1>Piano Roll Players</h1>

    <script>
        function createPlayer(imageSrc, audioSrc) {
            const html = `
  <div class="player">
    <div class="container">
      <img src="${imageSrc}" class="pianoRoll">
      <div class="playhead"></div>
    </div>
    <div class="controls">
      <button class="playBtn">▶ 再生</button>
      <button class="stopBtn">■ 停止</button>
    </div>
    <audio src="${audioSrc}"></audio>
  </div>
  `;
            document.write(html);
        }

        function bindPlayers() {
            document.querySelectorAll(".player").forEach(player => {
                const audio = player.querySelector("audio");
                const playhead = player.querySelector(".playhead");
                const img = player.querySelector("img");
                const playBtn = player.querySelector(".playBtn");
                const stopBtn = player.querySelector(".stopBtn");
                let animationFrame;

                // 再生ボタン
                playBtn.addEventListener("click", () => {
                    audio.currentTime = 0;
                    audio.play();
                    startAnimation();
                });

                // 停止ボタン
                stopBtn.addEventListener("click", () => {
                    audio.pause();
                    audio.currentTime = 0;
                    cancelAnimationFrame(animationFrame);
                    playhead.style.left = "0px";
                });

                // 再生ヘッドを動かす
                function startAnimation() {
                    const duration = audio.duration;

                    function step() {
                        if (!audio.paused) {
                            const width = img.clientWidth;  // 表示されている幅を取得
                            const progress = audio.currentTime / duration;
                            playhead.style.left = (progress * width) + "px";
                            animationFrame = requestAnimationFrame(step);
                        }
                    }
                    step();
                }
            });
        }
    </script>

    <!-- プレイヤーを埋め込む -->
    <script>
        createPlayer("piano1.png", "wav1.wav");
        createPlayer("piano2.png", "wav2.wav");
        window.onload = bindPlayers;
    </script>

</body>

</html>